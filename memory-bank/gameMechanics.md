# Игровая Механика и Правила

Этот документ описывает основные игровые механики, правила взаимодействия объектов, ограничения и технические детали реализации игры Skazmor.

## 1. Основной Игровой Цикл

Игра построена на пошаговой системе управления ресурсами и картами.

1.  **Раздача (Deal):**
    *   На игровом столе есть **4 слота** для карт.
    *   В начале игры и при смене раунда слоты заполняются картами из колоды.
    *   Раунд продолжается до тех пор, пока на столе не останется **1 или 0 карт**.
    *   Когда это условие выполнено, начинается новый раунд: пустые слоты заполняются новыми картами из колоды.
2.  **Действия Игрока:**
    *   Игрок взаимодействует с картами на столе, перемещая их в руки или атакуя ими.
    *   Ход не ограничен по времени.
3.  **Условия Победы и Поражения:**
    *   **Победа:** Колода пуста **И** на столе не осталось монстров (все карты убраны).
    *   **Поражение:** Здоровье (HP) игрока падает до 0 или ниже.

## 2. Сущности и Ресурсы

### Игрок
*   **HP (Здоровье):** Стандартный максимум — 13. Может быть уменьшен способностью *Изнурение* или увеличен (теоретически, но обычно ограничен MaxHP).
*   **Coins (Монеты):** Валюта для покупки/продажи (в данной версии — счет очков).
*   **Руки (Slots):**
    *   **Left Hand / Right Hand:** Активные слоты для использования предметов (оружие, щиты, заклинания).
    *   **Backpack (Рюкзак):** Слот хранения. Предметы в рюкзаке нельзя использовать напрямую (кроме продажи), их нужно переложить в активную руку. Зелья в рюкзаке не пьются автоматически.

### Карты
Типы карт (`CardType`):
*   **Monster (Монстр):** Враг с показателем HP/Атаки.
*   **Weapon (Оружие):** Одноразовый предмет для атаки. Имеет значение урона.
*   **Shield (Щит):** Предмет для блокирования урона. Имеет значение прочности.
*   **Potion (Зелье):** Восстанавливает HP.
*   **Coin (Монета):** Дает золото.
*   **Spell (Заклинание):** Магический свиток с уникальным эффектом.
*   **Skull (Череп):** "Мусорная" карта, не имеет эффекта, занимает слот.

## 3. Механики Взаимодействия

### Взятие карт (`TAKE_CARD_TO_HAND`)
*   Игрок может взять карту со стола в левую руку, правую руку или рюкзак, если слот свободен.
*   **Зелья:** Если берутся в левую/правую руку — выпиваются мгновенно. Если в рюкзак — сохраняются.
    *   *Гниль (Rot):* Если активен дебафф, лечение снижается на 2.
    *   *Закуска (Snack):* Если активно, избыточное лечение (Overheal) превращается в монеты.
*   **Монеты:** Собираются мгновенно при попытке взять в руку (превращаются в валюту).
    *   *Подношение (Offering):* Если на столе есть монстр с этой способностью, монета не дается игроку, а лечит монстра.
*   **Ограничения:**
    *   *Паутина (Web):* Блокирует использование рюкзака.
    *   *Эхо (Echo):* Дублирует взятый предмет в рюкзак (если есть место).

### Бой (`INTERACT_WITH_MONSTER`)

#### Атака Монстра Оружием
*   Оружие одноразовое. После удара оно уходит в сброс.
*   **Урон:** Если Урон >= HP Монстра, монстр умирает. Иначе HP монстра уменьшается.
*   **Overkill:** Избыточный урон записывается в статистику.
*   *Бегство (Flee):* Если у монстра остается 3 HP или меньше, он может сбежать обратно в колоду.

#### Атака Монстром (Защита)
Игрок может "перетащить" монстра на себя или свой щит.
1.  **Удар по телу (Player):**
    *   Игрок получает урон, равный атаке монстра.
    *   Монстр **умирает** после атаки (самопожертвование), если не сработал *Отвод (Deflection)*.
    *   *Доспехи (Armor):* Полностью блокируют один удар.
    *   *Отвод (Deflection):* Отражает урон в другого монстра или в самого атакующего.
2.  **Удар по щиту (Shield):**
    *   Щит поглощает урон. Прочность щита уменьшается.
    *   Если Урон > Прочности щита, остаток (Overflow) наносится игроку, щит ломается.
    *   Монстр умирает после атаки.
    *   *Топот (Trample):* Монстр с этой способностью игнорирует прочность и мгновенно ломает щит, но урон игроку не наносится (щит принимает удар ценой жизни).

### Использование Заклинаний (`USE_SPELL_ON_TARGET`)
Заклинания применяются из рук на цель (Игрок, Монстр, Карта).
*   **Silence (Молчание):** Блокирует использование любой магии, пока жив монстр с этой способностью.
*   **Список эффектов (примеры):**
    *   *Escape (Побег):* Замешивает всех врагов на столе обратно в колоду.
    *   *Leech (Кровосос):* Высасывает жизнь из монстра (урон монстру = лечение игроку).
    *   *Potionify:* Превращает предмет в зелье.
    *   *Sacrifice (Жертва):* Наносит монстру урон, равный потерянному HP игрока.
    *   *Merchant (Скупщик):* Удваивает стоимость предмета при продаже.
    *   *Split (Расщепление):* Делит монстра на двух с половиной HP.

### Продажа (`SELL_ITEM`)
*   Можно продать предмет из руки или со стола за монеты (значение карты).
*   Монстров продавать нельзя.
*   *Крик (Scream):* Блокирует возможность продажи.

### Сброс (`RESET_HAND`)
*   Позволяет сбросить текущие карты со стола в колоду и перераздать руку.
*   **Цена:** 5 HP.
*   **Условие:** Нельзя использовать, если HP <= 5 или на столе 4 карты (полная рука).

## 4. Способности Монстров (Abilities)

Способности делятся на срабатывающие при появлении (Spawn), при смерти (Kill), пассивные и активные при взаимодействии.

Полный список способностей, их иконок и детальных описаний эффектов находится в документе **[Каталог Игрового Контента](gameContent.md#2-способности-монстров-monster-abilities)**.

В данном документе (Mechanics) важно понимать их классификацию по триггерам (когда они срабатывают):

*   **Spawn (При появлении):** Ambush, Corpseeater, Mirror.
*   **Passive (Пассивные):** Silence, Stealth, Web, Scream, Rot, Exhaustion, Parasite.
*   **Kill (При смерти):** Commission, Whisper, Breach, Disarm, Blessing, Legacy, Beacon, Bones, Junk, Theft, Corrosion, Miss.
*   **Trigger/Combat (В бою/При условии):** Offering, Trample, Flee.

## 5. Техническая Реализация

### State Management
Используется паттерн `Reducer` (`gameReducer.ts`). Состояние (`GameState`) неизменяемо, каждое действие возвращает новый объект состояния.

**Ключевые поля State:**
*   `deck`: Массив карт (стек).
*   `enemySlots`: Массив из 4 элементов (`Card | null`).
*   `activeEffects`: Массив строк (`['miss', 'armor', ...]`) для временных баффов/дебаффов.
*   `hpUpdates`: Лог изменений здоровья для анимаций.
*   `logs`: Текстовый лог событий.

### Game Logic
*   **Очередность:** Обработка действий происходит синхронно.
*   **Логгер:** Все значимые действия пишутся в `logs` с типом (combat, heal, info).
*   **God Mode:** Флаг `isGodMode` предотвращает получение урона и позволяет делать сброс бесплатно.

### Ограничения Реализации
*   **Стек эффектов:** Эффекты типа "следующий удар" (`activeEffects`) снимаются сразу после срабатывания.
*   **Взаимодействие:** Блокировки (Stealth, Silence) проверяются в начале кейса редьюсера. Если условие блокировки активно, действие отменяется (`return state` или `break`).

