# Блок 6 — Composition Root (`App`) + “плагины” (подключаем фичи без нового монолита)

## Цель блока
Сделать так, чтобы:
- `App.tsx` оставался **тонким composition root**, а не “новым `GameScreen`”,
- подключение фич (game session, in‑game навигация, devquest/оверлеи, auth/wallet) было модульным,
- внутриигровые экраны (Variant A: `inGameView`) могли развиваться без переписывания `App`.

## Scope
### Делаем
- Вводим слой `src/app/` (или аналог) как место сборки:
  - навигация верхнего уровня (menu/game/stats/deckbuilder)
  - провайдеры/контейнеры жизненного цикла (GameSession, content packs, инфраструктура)
- Выделяем “плагины”/подсистемы, которые сейчас живут в `App.tsx` и/или поверх всего UI:
  - devquest (idle/magic words/секретки)
  - оверлеи (ghost/slime/flashlight) как отдельные модули
- Определяем “контракты подключаемости”: как модуль добавляется, что ему доступно (например, доступ к auth/session/settings).

### Не делаем
- Не делаем полноценный роутинг (React Router) — остаёмся на текущей модели + `inGameView`.
- Не переписываем весь UI, только меняем “точку сборки”.

## Контекст: что сейчас в `App.tsx`
Сейчас `src/App.tsx` одновременно:
- держит навигацию `menu/game/stats/deckbuilder`
- содержит devquest‑логику (idle, magic words, клики, key buffer)
- подключает глобальные оверлеи (`GhostTrailOverlay`, `FlashlightOverlay`, `SlimeOverlay`)
- показывает dev console и settings modal

Это нормально на ранней стадии, но для масштабирования (сюжет/комнаты/плагины) лучше отделить.

## Предлагаемая структура
- `src/app/`
  - `AppShell.tsx` (глобальный layout/фон/оверлеи)
  - `AppRouter.tsx` (верхнеуровневые экраны)
  - `providers/`
    - `GameSessionProvider.tsx` (жизненный цикл game session в пределах game-флоу)
    - `ContentProvider.tsx` (выбор/сборка `GameContent` и packs)
    - `InfrastructureProvider.tsx` (инъекция репозиториев/адаптеров, если нужно)
  - `plugins/`
    - `DevQuestPlugin.tsx` (подписки на события, “аномалии”, секретки)
    - `OverlaysPlugin.tsx` (ghost/slime/flashlight — как один модуль)

*Примечание:* это план. Реально можно начать с 1–2 файлов, чтобы не плодить папки сразу.

## Ключевой принцип
**`App` не должен знать деталей фич.**  
Он должен:
- выбрать “какой экран показывать”
- подключить провайдеры/плагины
- передать минимальные зависимости

## План миграции (маленькими порциями)
### Шаг 6.1 — Вынести “внешние оверлеи” в `AppShell`
- Создать `AppShell` и перенести туда:
  - фон/обертку
  - `GhostTrailOverlay`, `FlashlightOverlay`, `SlimeOverlay`
  - `DevConsole` (если он глобальный)

### Шаг 6.2 — Вынести devquest‑логику в `DevQuestPlugin`
- Вынести useEffect’ы (idle, magic words, click sequences, key buffer).
- Плагин должен быть “самодостаточным”: подключается/отключается, не ломает остальное.

### Шаг 6.3 — Ввести `AppRouter` (тонкий)
- Оставить логику навигации верхнего уровня, но вынести в отдельный компонент/модуль.
- `App.tsx` становится “склейкой” `AppShell + AppRouter`.

### Шаг 6.4 — Подготовить “game flow boundary”
Так как сессия живёт между внутриигровыми экранами, но не обязана жить в меню:
- выделить “границу game‑флоу” (условно `GameFlowRoot`)
- внутри `GameFlowRoot` живёт `GameSessionProvider` и `inGameView` навигация (см. блоки 2 и 2A)

## Риски
- Легко случайно сломать глобальные слушатели событий (keydown/click/mousemove).
  - Снижение: один владелец подписок (DevQuestPlugin), явный cleanup.
- Можно создать слишком много “провайдеров”.
  - Снижение: вводить по мере надобности, начиная с `AppShell` + `DevQuestPlugin`.

## Критерии готовности (DoD)
- `App.tsx` стал тонким (ориентир: ~50–100 строк).
- Devquest и оверлеи подключаются как модуль, и их можно отключить без ломки игры.
- Появилось место (`GameFlowRoot`), где логично держать `GameSession` и внутриигровую навигацию.

## Чеклист регресса (ручной)
- Меню/статы/декбилдер открываются.
- В игре работают оверлеи/пасхалки/консоль как раньше.
- Выход в меню по‑прежнему завершает сессию (если так решено в блоках 2/2A).


