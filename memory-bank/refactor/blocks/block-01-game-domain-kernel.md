# Блок 1 — Game Domain Kernel (выделение доменного ядра игры)

## Цель блока
Выделить минимальное “ядро игры”, которое:
- не зависит от React/DOM/Zustand/Supabase/LocalStorage,
- можно читать/тестировать отдельно,
- при этом **не меняет поведение игры** (refactor-only).

## Scope
### Делаем
- Формируем **доменный модуль** для Game (папки/файлы) и переносим туда существующую логику:
  - `GameState`, `GameAction`, `Card`, `CurseType`, и т.д.
  - `gameReducer` + его хелперы
  - `createDeck/shuffleDeck` (позже это будет use-case, но на этом блоке переносим как есть)
- Подготавливаем место для будущих “портов” (RNG/Clock), но без агрессивной переделки.
- Обеспечиваем обратную совместимость для UI через **тонкие ре-экспорты**, чтобы `GameScreen` не переписывать в этом блоке.

### Не делаем
- Не меняем правила игры, баланс, эффекты карт/проклятий.
- Не трогаем UI-компоненты (кроме правок импортов на новые ре-экспорты).
- Не вводим новый state-manager (остаёмся на `useReducer`).
- Не переписываем систему контента (SPLLS/CURSES/ABILITIES) — это Блок 4.

## Затрагиваемые файлы/папки (план)
Создадим новые папки (пока без идеального финального вида, но в духе Clean Architecture):
- `src/features/game/domain/model/`
- `src/features/game/domain/reducer/`
- `src/features/game/domain/deck/` (временная зона для createDeck/shuffleDeck)
- `src/features/game/domain/index.ts` (ре-экспорты)

И тонкие “мосты” для старых импортов (на время миграции):
- `src/types/game.ts` (может стать ре-экспортом или остаться как “старый фасад”)
- `src/utils/gameReducer.ts` / `src/utils/gameLogic.ts` (ре-экспорт/обёртка на новые файлы)

## Ключевые вопросы (можно отвечать “не знаю”)
1) **Названия папок**: тебе нравится структура `features/game/domain/...` или хочешь “слойно” (`src/domain/game/...`)?
2) **Ок ли временно держать ре-экспорты** в `src/utils/*` и `src/types/*`, чтобы UI не ломался, а потом убрать их в отдельном блоке?
3) **Недетерминизм**: в этом блоке оставляем `Math.random/Date.now` как есть (и просто помечаем долг), или сразу хочешь вынести в `Rng/Clock` порты?

## Зафиксировано по ответам (сейчас)
- **Ре‑экспорты — да**: это помогает сделать миграцию плавной и не трогать UI на Блоке 1.
- **Структура папок — пока “не знаю”**: держим цель “логичность и простота”. Дефолт‑вариант: `src/features/game/domain/...` (как в этом мини‑плане), но финально можем поправить в Блоке 0 перед началом переноса.
- **RNG/Clock — пока “не знаю”**: безопасный дефолт на Блоке 1 — оставить `Math.random/Date.now` и пометить техдолг; вынос в порты сделать отдельным маленьким шагом, когда появится нужда в тестах/реплеях.
- **Сессия между экранами — да**: значит перенос домена (Блок 1) готовит почву, но “где живёт state” решаем на Блоке 2 (GameSession/Application), чтобы состояние не умирало при размонтировании `GameScreen`.

## План миграции (маленькими порциями)
### Шаг 1.1 — Создать каркас доменного модуля и добавить русские комментарии
- Добавить папки `features/game/domain/*`.
- В `index.ts` и ключевых файлах добавить короткие header‑комментарии на русском:
  - что это домен
  - что сюда нельзя тянуть UI/infra

**Откат:** удалить новые папки (если ещё не подключали).

### Шаг 1.2 — Перенести модели (types) в domain/model
- Переносим `Card`, `Player`, `GameState`, `GameAction`, связанные типы.
- Следим, чтобы не появилось импортов из UI/infra.

**Откат:** вернуть типы в `src/types/game.ts`.

### Шаг 1.3 — Перенести `gameReducer` и хелперы в domain/reducer
- Переносим “как есть”, без изменения логики.
- На время оставляем public API прежним: `gameReducer`, `initialState`.

**Откат:** вернуть редьюсер обратно в `src/utils/gameReducer.ts`.

### Шаг 1.4 — Перенести `createDeck/shuffleDeck` в domain/deck (временная зона)
- Переносим `src/utils/gameLogic.ts` в `features/game/domain/deck/*`.
- Если внутри есть зависимости на `data/*` — фиксируем это как “пока допустимо”, но отмечаем как цель Блока 4.

**Откат:** вернуть файл обратно.

### Шаг 1.5 — Включить обратную совместимость через ре-экспорты
Чтобы не переписывать `GameScreen` сейчас:
- `src/utils/gameReducer.ts` будет просто ре-экспортить `gameReducer/initialState` из нового места.
- `src/utils/gameLogic.ts` будет ре-экспортить `createDeck/shuffleDeck`.
- `src/types/game.ts` либо остаётся источником типов, либо становится ре-экспортом (выберем 1 вариант).

**Откат:** убрать ре-экспорты и вернуть прямые импорты.

## Риски
- **Риск:** циклические импорты при переносе типов/редьюсера.
  - **Снижение:** сначала типы, потом редьюсер; держать домен без ссылок на UI.
- **Риск:** “случайно изменили логику” при переносе.
  - **Снижение:** перенос маленькими кусками, без форматирования/рефакторинга выражений; после каждого шага запуск.

## Критерии готовности (DoD)
- Игра запускается без изменений поведения.
- Доменные файлы не импортят React/Zustand/Supabase/LocalStorage.
- Старые импорты продолжают работать через ре-экспорты (временный слой совместимости).

## Чеклист регресса (ручной)
- Запуск игры: старт стандартный/кастомный.
- Базовые действия: взять карту, атаковать, спелл, продажа, сброс.
- Проклятия (если активны в текущем билде): выбор/активация, Fog/Full Moon и т.д.

## Документация
- Блок 1 — рефакторинг без изменения механик, поэтому `gameMechanics.md` не меняем.
- Если в процессе выяснится “неочевидная” архитектурная причина/граница — обновить `memory-bank/refactor/plan-v1.md`.

---

## Последнее обновление
- 2025-12-19 — Добавлена секция “Последнее обновление” (Блок 90).

