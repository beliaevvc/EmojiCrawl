# Блок 0 — Предохранители и правила (Guardrails)

## Цель блока
Создать “рельсы”, чтобы большой рефакторинг шёл **без поломок** и без расползания архитектуры: понятные границы слоёв, удобные импорты, минимальные проверки и договорённости, которые легко соблюдать.

## Scope
### Делаем
- Фиксируем **правила зависимостей** (domain/application/ui/infrastructure/content) и где они живут в дереве.
- Добавляем **алиасы импортов** (чтобы рефакторинг не превратился в “../../../../” и не мешал переносам).
- Добавляем **минимальные проверки**, чтобы случайно не протащить React/Supabase в domain.
- Подготавливаем каркас для будущих тестов доменной логики (по желанию).

### Не делаем (важно)
- Не переносим крупные файлы и не меняем бизнес‑логику игры.
- Не переписываем `GameScreen`/`gameReducer` — это **следующие блоки**.
- Не добавляем новые игровые механики/контент.

## Затрагиваемые файлы/папки (ориентир)
- `tsconfig.json` (или новый `tsconfig.paths.json` — если решим так)
- `vite.config.ts` (для `resolve.alias`, если нужно)
- (опционально) `.eslintrc*` / `eslint` настройки — если в репо уже есть конфиг (проверим перед правками)
- (позже) `src/` структура (создание пустых папок `src/features`, `src/shared`, `src/infrastructure`, `src/content`) — **без переноса кода** на этом блоке
- `memory-bank/refactor/plan-v1.md` (если уточняем правила)

## План миграции (маленькими порциями)
### Шаг 0.1 — Зафиксировать “правила границ” в коде (комментариями на русском)
**Почему:** когда начнём переносить файлы, читателю нужно сразу понимать “что это за слой”.
- Добавить короткие header‑комментарии в новые папки/индекс‑файлы (когда появятся) в стиле:
  - “Domain: чистая логика, без React/Storage”
  - “Infrastructure: адаптеры Supabase/LocalStorage”

**Откат:** удалить комментарии (без влияния на функционал).

### Шаг 0.2 — Ввести алиасы импортов
**Цель:** при переносах файлов менять пути одним местом.

**Предложение алиасов:**
- `@/` → `src/`
- `@features/` → `src/features/`
- `@shared/` → `src/shared/`
- `@infra/` → `src/infrastructure/`
- `@content/` → `src/content/`

**Шаги:**
- Настроить алиасы в TS (`compilerOptions.paths`) и в Vite (`resolve.alias`), если потребуется.
- Сделать 1–2 безопасных перевода импортов в существующем коде как smoke‑проверку (например, `src/lib/supabase.ts` импорт из `@/lib/supabase`).

**Откат:** вернуть старые относительные импорты.

### Шаг 0.3 — Мини‑проверка “domain не тащит UI/infra”
**Цель:** заранее отловить главную архитектурную ошибку.

Варианты (выберем минимальный и быстрый):
- **Вариант A (самый лёгкий):** договорённость + ревью + поиск по импорту (дешево, но ручное).
- **Вариант B (лучше):** ESLint rule/ограничение импортов (например “из `src/features/game/domain` нельзя импортить `react`, `zustand`, `@supabase/*`”).
- **Вариант C:** “typecheck отдельного домена” (тяжелее, обычно позже).

**Откат:** убрать правило линтера (не влияет на рантайм).

### Шаг 0.4 — (Опционально) Минимальный тестовый контур для domain (Vitest)
**Цель:** иметь хотя бы 2–3 “якорных” теста, чтобы последующий перенос не ломал правила.

**Важно:** тесты только для **чистой логики** (reducer/rules), без UI.

**Откат:** убрать тесты/конфиг, если мешает.

## Риски
- **Риск:** алиасы ломают сборку из‑за несовпадения TS/Vite конфигураций.
  - **Снижение:** вводить алиасы по одному, проверить `npm run build` (или хотя бы `tsc`) после каждого шага.
- **Риск:** линтер‑правила начнут “ругаться” на старый код.
  - **Снижение:** правила применять только к будущим папкам `features/*/domain` и т.п.

## Критерии готовности (DoD)
- Есть согласованный набор алиасов и он работает в dev/build.
- Есть зафиксированное правило границ (в документации + по возможности автоматическая проверка).
- Никаких изменений геймплея/поведения.

## Чеклист регресса (ручной)
- `npm run dev` запускается.
- Меню → старт игры → базовые действия работают.
- Декбилдер открывается и сохраняет/загружает шаблоны.

## Документация
- Этот блок не меняет механику/контент, поэтому **`gameMechanics.md`/`gameContent.md` обычно не трогаем**.
- Если меняем принципы/структуру папок/правила импортов — обновить:
  - `memory-bank/refactor/plan-v1.md` (если менялись решения)
  - (при необходимости) `memory-bank/systemPatterns.md` (как “конституция” проекта)


