# Блок 3 — Декомпозиция UI (GameScreen → сборные компоненты)

## Цель блока
Превратить текущий монолит `src/components/GameScreen.tsx` в:
- “экран‑компоновку” (тонкий слой),
- набор переиспользуемых UI‑компонентов/окон/оверлеев/хуков,
чтобы потом можно было **собирать новые внутриигровые экраны** (сюжет/комнаты/награды/магазин/пауза) без копипасты и без встраивания логики в один файл.

## Scope
### Делаем
- Декомпозируем `GameScreen.tsx` по ответственностям (визуал, окна HUD, модалки, DnD, эффекты).
- Выносим внутренние “окна” и “viewer’ы” из `GameScreen.tsx` в отдельные компоненты:
  - `CardsViewer`
  - `OverheadStatsWindow`
  - `GameLogWindow`
  - (по мере необходимости) части HUD/стата‑панелей/панель управления
- Выносим “DnD зоны” и обработчики в отдельные компоненты/хуки, чтобы UI стал “сборным”.
- Добавляем понятные **комментарии на русском** в местах, где проходят границы слоёв/подсистем UI.

### Не делаем
- Не меняем механику/баланс/правила — это не блок про game logic.
- Не внедряем полноценный роутинг (React Router) — у нас выбран Variant A (`inGameView`), см. `block-02a`.
- Не переписываем весь UI на новый дизайн — цель архитектурная.

## Контекст: что сейчас “смешано” в GameScreen
`GameScreen.tsx` одновременно содержит:
- хранение game state через `useReducer(gameReducer, initialState)`
- локальные UI state: модалки, выбранная карта, настройки HUD, подтверждения, позиции окон
- DnD (“куда можно дропнуть” + правила блокировок)
- визуальные эффекты (shake/pulse/floating texts/HP animation)
- встроенные UI окна (viewer’ы, логи, оверхеды)
- glue‑код, который напрямую вызывает `dispatch(...)`

## Предлагаемая целевая структура UI (в рамках текущего `src/`, без финального “features” пока)
Минимально‑инвазивно, чтобы потом переехать в `features/game/ui/...`:

- `src/components/game/` (новая папка, как промежуточная точка)
  - `screens/`
    - `GameScreen.tsx` (тонкая компоновка)
  - `board/`
    - `GameBoard.tsx` (поле: слоты врагов + взаимодействие)
    - `HandPanel.tsx` (левая/правая/рюкзак)
  - `hud/`
    - `GameHudBar.tsx` (верхняя панель: hp/coins/кнопки/curse slot)
    - `HudWindows.tsx` (окна: логи/статы/лейблы/вьюверы)
  - `windows/`
    - `CardsViewer.tsx`
    - `GameLogWindow.tsx`
    - `OverheadStatsWindow.tsx`
  - `dnd/`
    - `EnemySlotDropZone.tsx`
    - `SellZone.tsx`
    - `InteractionZone.tsx`
    - (или хуки `useEnemyDropZone`, `useSellZone`)
  - `effects/`
    - `FloatingTextController.tsx` / `useFloatingTextController`
    - `useSequentialHp.ts` (текущая анимация hpUpdates)
  - `modals/`
    - `GameModals.tsx` (центр управления модалками: правила/курсы/подтверждения/карточный зум)

*Примечание:* это промежуточная структура. На блоках 1–2 мы всё равно придём к `features/game/ui`, но сейчас важнее **разрезать монолит** и сохранить поведение.

## План миграции (маленькими порциями)
### Шаг 3.1 — Вынести “окна” без изменения поведения
Первыми выносим то, что уже изолировано:
- `CardsViewer`
- `OverheadStatsWindow`
- `GameLogWindow`

Почему: минимальный риск, понятные props (`cards/logs/overheads`, `position`, `onPositionChange`).

### Шаг 3.2 — Вынести DnD зоны (drop wrappers) из файла экрана
- `InteractionZone`, `EnemySlotDropZone`, `SellZone`
Цель: чтобы правила `canDrop/drop` не жили в `GameScreen`.

Важно: не менять логику блокировок (fog/stealth/scream/web), только перенести.

### Шаг 3.3 — Вынести контроллер эффектов
Кандидаты:
- sequential HP animation (`hpUpdates` → `visualHp`)
- floating texts (`addFloatingText/removeFloatingText`)
- визуальные реакции (hero shake, coin pulse)

Цель: чтобы “визуальные эффекты” стали отдельной подсистемой и их можно было переиспользовать в других внутриигровых экранах.

### Шаг 3.4 — Вынести модалки в единый `GameModals`
Свести все `<AnimatePresence>...` модалки в один компонент:
- rules
- curse picker + confirm
- restart/exit confirm
- card zoom
- HUD settings
- peek/scout overlays (если это не модалка, всё равно централизовать)

### Шаг 3.5 — Разрезать основной layout на “board” и “hud”
Цель: “GameScreen как компоновка”:
- `GameHudBar` (верхняя/нижняя панель управления)
- `GameBoard` (поле)
- `HudWindows` (плавающие окна и их позиции)

## Риски
- Декомпозиция может сломать DnD из‑за ref/замыканий.
  - Снижение: переносить без изменения логики, по одному компоненту, с ручной проверкой.
- Ререндеры/производительность: при выносе важно не протащить слишком много props.
  - Снижение: передавать только нужное; позже добавить мемоизацию/селекторы (не в этом блоке).

## Критерии готовности (DoD)
- `GameScreen.tsx` заметно уменьшился (ориентир: < 300–400 строк).
- Все вынесенные компоненты имеют русские поясняющие комментарии “что это” и “какие границы”.
- Поведение игры визуально не изменилось.
- Стало возможно подключать новые внутриигровые экраны рядом с `combat` (см. `block-02a`) без копирования логики из `GameScreen`.

## Чеклист регресса (ручной)
- Базовые действия в бою работают (drag/drop, клики, спеллы).
- Окна HUD двигаются и запоминают позиции, видимость работает.
- Модалки открываются/закрываются как раньше.
- Fog/stealth/web/scream блокировки не сломались.

## Документация
- Если меняем дизайн‑паттерны UI (layout, окна, модалки) — обновить `memory-bank/uiDesign.md`.
- Если затрагиваем HUD‑подсистему — свериться с `memory-bank/infoHUD.md`.


